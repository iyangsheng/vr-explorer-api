# WBS

## 前端单机部署

### 1. 安装 NGINX

```nginx
# 安装NGINX
apt-get install nginx

# 修改配置 配置如下
vi /etc/nginx/sites-available/default

# 重新加载配置
service nginx reload

# 查看NGINX运行情况
systemctl status nginx.service
```

### 2. 配置 NGINX

```nginx
# B端&报告
server {
    listen 80;
    listen [::]:80;
    server_name [B端域名];
    root /visdata/visfitweb/cms;
    index index.html;

    # B端接口反代
    location /api/ {
        proxy_pass http://127.0.0.1:4001/;
    }

    # 模型缓存服务反代
    location /modelfile/ {
        proxy_pass http://127.0.0.1:6000/;
    }

    # 打印服务反代
    location /reptfile/ {
        proxy_pass http://127.0.0.1:3000/;
    }

    # B端前端重定向
    location / {
        try_files $uri $uri/ /index.html;
    }
}


# 售后
server {
       listen 80;
       listen [::]:80;

       server_name [售后域名];

       root /visdata/visfitweb/cust;
       index index.html;

       # 售后接口反代
       location /api/ {
            proxy_pass http://127.0.0.1:4002/;
       }

       # 售后前端重定向
       location / {
               try_files $uri $uri/ /index.html;
       }
}
```

### 3. 部署 Web

拉取构建代码：[https://gitee.com/suanier/vfair-deployment/tree/feat/vr-explorer/amd/vr-explorer](https://gitee.com/suanier/vfair-deployment/tree/feat/vr-explorer/amd/vr-explorer)

```bash
# 接口地址改为反代地址
$ vi build.sh

# B端接口地址
GYM_API_HOST=http://rexp-dev.visbody.com/api
# B端域名
GYM_HOST=http://rexp-dev.visbody.com
GYM_HMT_ID=7001beb8adad2d7404f71958188f2c25


# 售后接口地址
CUST_API_HOST=http://rexp-cust-dev.visbody.com/api


# 运行构建脚本 根据反馈输入构建项目及版本号
$ bash build.sh
```

### 4. 部署后端

注意修改模型及打印地址为反代地址

```bash
$ vi .env

MODEL_FILE_PATH=http://rexp-dev.visbody.com/modelfile
REPORT_FILE_PATH=http://rexp-dev.visbody.com/reptfile
```

### 5. 打印服务配置

```bash
$ vi .env

# 取消域名校验
IS_CHECK_DOMAIN=false
# gym_api后端接口地址（参考调试）
VR_EXP_GYM_API_PATH=http://rexp-dev.visbody.com/api
# 报告前端页面地址（参考调试）
VR_EXP_REPORT_PAGE_URL=http://rexp-dev.visbody.com
# 报告域名地址（参考调试）
VR_EXP_REPORT_FILE_HOST=rexp-dev.visbody.com

```

### 6. 数据库创建

[Dump20210726.sql](https://visbodydev.yuque.com/attachments/yuque/0/2021/sql/287793/1627263051784-620a5ce7-d07b-445c-82df-221501dc76c8.sql?_lake_card=%7B%22src%22%3A%22https%3A%2F%2Fvisbodydev.yuque.com%2Fattachments%2Fyuque%2F0%2F2021%2Fsql%2F287793%2F1627263051784-620a5ce7-d07b-445c-82df-221501dc76c8.sql%22%2C%22name%22%3A%22Dump20210726.sql%22%2C%22size%22%3A87026%2C%22type%22%3A%22%22%2C%22ext%22%3A%22sql%22%2C%22status%22%3A%22done%22%2C%22taskId%22%3A%22ue6de2190-cbf3-44f7-a697-c321f3c1603%22%2C%22taskType%22%3A%22upload%22%2C%22id%22%3A%22ucbdf3758%22%2C%22card%22%3A%22file%22%7D)
数据库初始化（调试库导入）

| admin_group         | 群组信息表         |
| ------------------- | ------------------ |
| admin_perm          | 管理员权限表       |
| bm_level_info       | 体成分等级详情表   |
| bm_mass_quota       | 体成分指标表       |
| bs_level_info       | 体态评估等级详情表 |
| email_template      | 邮件模板表         |
| email_type          | 邮件类型表         |
| scan_file_type_info | 扫描文件类型表     |
| time_zone           | 时区表             |
|                     |                    |
