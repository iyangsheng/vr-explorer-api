# 整体时序图

![](https://cdn.nlark.com/yuque/__puml/298220d2172d761477ac9f011ece06e6.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYXV0b251bWJlclxucGFydGljaXBhbnQgXCJC56uvXCIgIGFzIEJFbmRcbnBhcnRpY2lwYW50IFwi6K6-5aSH56uvXCIgYXMgQ2xpZW50XG5wYXJ0aWNpcGFudCBcIuaOp-WItuacjeWKoVwiIGFzIENvbnRyb2xTZXJ2ZXJcbnBhcnRpY2lwYW50IFwi54q25oCB5pyN5YqhXCIgYXMgU3RhdHVzU2VydmVyXG5wYXJ0aWNpcGFudCBcIuaVsOaNruW6k1wiIGFzIERhdGFCYXNlXG5cbj09PT09IFdlYuerryDorr7nva7ml7bljLogPT09PVxuYWN0aXZhdGUgQkVuZFxuYWN0aXZhdGUgRGF0YUJhc2VcbkJFbmQtPiBEYXRhQmFzZTog6K6-572u5pe25Yy6XG5EYXRhQmFzZSAtPiBCRW5kOiDorr7nva7ml7bljLrlk43lupRcbmRlYWN0aXZhdGUgQkVuZFxuXG49PT09PSDorr7lpIfnq68g6K6-572u5pe25Yy6ID09PT1cbm5vdGUgcmlnaHQgb2YgQ2xpZW50OiDlvIDmnLrmiJbnvZHnu5zmlq3lvIDph43ov57lkI7kvJrlj5Hotbforr7lpIfms6jlhozvvIzlpoLmnpzms6jlhozlpLHotKXkvJrlnKjlv4Pot7PkuK3ph43mlrDms6jlhoxcbkNsaWVudCAtPiBTdGF0dXNTZXJ2ZXI6IOiuvuWkh-azqOWGjCByZWdpc3RlclJlcXVlc3RcbmFjdGl2YXRlIENsaWVudFxuYWN0aXZhdGUgU3RhdHVzU2VydmVyXG5TdGF0dXNTZXJ2ZXIgLT4gRGF0YUJhc2U6IOafpeivouS_oeaBr1xuRGF0YUJhc2UgLT4gU3RhdHVzU2VydmVyOiDmkLrluKZ0aW1lem9uZeaXtuWMuui_lOWbnuWTjeW6lFxuZGVhY3RpdmF0ZSBEYXRhQmFzZVxuU3RhdHVzU2VydmVyIC0-IENsaWVudDog6K6-5aSH5ZON5bqUIHJlZ2lzdGVyUmVzcG9uc2UgKOWinuWKoCDorr7lpIcgdGltZXpvbmUg5a2X5q61KVxuZGVhY3RpdmF0ZSBTdGF0dXNTZXJ2ZXJcbkNsaWVudCA8LT4gQ2xpZW50OiDorr7lpIfkv6Hmga_mm7TmlrDvvIhkZXZpY2VJbmZv44CKdnV444CL77yJ5aKe5Yqg77yI6K6-5aSHIHRpbWV6b25lIOaXtumXtOWcsOWMuu-8iVxuXG5hbHQg5byA5py65Yqo55S75YmN6I635Y-W5YiwdGltZXpvbmVcblx0Q2xpZW50IC0-IENvbnRyb2xTZXJ2ZXI6IGhhbmRsZUNoYW5nZVRpbWVab25lUmVx6K6-572u6K6-5aSHIHRpbWV6b25lIOaXtumXtOWcsOWMulxuYWN0aXZhdGUgQ29udHJvbFNlcnZlclxuXHRDb250cm9sU2VydmVyIC0-IENvbnRyb2xTZXJ2ZXI6IOiuvue9ruaXtuWMulxuZGVhY3RpdmF0ZSBDb250cm9sU2VydmVyXG5lbmRcblxuQ2xpZW50IC0-IENsaWVudDog5byA5py65Yqo55S7XG5cbj09PT09IOiuvuWkh-erryDkuIrkvKDml7bljLogPT09PVxuQ2xpZW50IC0-IENvbnRyb2xTZXJ2ZXI6IOWQr-WKqOa1i-mHjyBTY2FuUmVxdWVzdFxuYWN0aXZhdGUgQ29udHJvbFNlcnZlclxuXG5Db250cm9sU2VydmVyIC0-IENsaWVudDog5o6o6YCB5omr5o-PSUQgUG9zdFNjYW5JZCBcbmRlYWN0aXZhdGUgQ29udHJvbFNlcnZlclxuXG5DbGllbnQgPC0-IENsaWVudDog5a2Y5YKo77yIbWVhc3VyZUluZm8gSUTjgIp2dXjjgIsg5bm25aSE55CG5pys5Zyw5pe25Yy6XG5cbkNsaWVudCAtPiBDbGllbnQ6IOaJq-aPj0lE5a2Y5YKo5bm26I635Y-W5pys5Zyw5pe25Yy677yI6Ziy5q2i5pyJ5Lqb5Zyw5Yy65L2_55So5aSP5Luk5pe277yM5pe25Yy65Lya5Yqo5oCB5Y-Y5YyW77yJXG5cbkNsaWVudCAtPiBTdGF0dXNTZXJ2ZXI6IOmAmuefpea1i-mHj-exu-WeiyBTY2FuVHlwZVJlcXVlc3TvvIzlop7liqDml7bljLrmjqjpgIFcbmFjdGl2YXRlIFN0YXR1c1NlcnZlclxuU3RhdHVzU2VydmVyIC0-IERhdGFCYXNlOiDmn6Xor6LmlbDmja4gXG5hY3RpdmF0ZSBEYXRhQmFzZVxuRGF0YUJhc2UgLT4gU3RhdHVzU2VydmVyIDog5pWw5o2u5ZON5bqUXG5kZWFjdGl2YXRlIERhdGFCYXNlXG5TdGF0dXNTZXJ2ZXIgLT4gQ2xpZW50OiDmtYvph4_nsbvlnovlk43lupQgU2NhblR5cGVSZXNwb25zZe-8jOaOqOmAgeOAkOaVsOaNruW6k-a1i-mHj-aXtumXtOOAkVxuZGVhY3RpdmF0ZSBTdGF0dXNTZXJ2ZXJcblxuQ2xpZW50IC0-IENsaWVudDog5pi-56S644CB5o6S5bqPIOagueaNruOAkOaVsOaNruW6k-a1i-mHj-aXtumXtCArIOaXtuWMuuOAkeaNoueul-aOkuW6j1xuXG5kZWFjdGl2YXRlIENsaWVudFxuQGVuZHVtbCIsInVybCI6Imh0dHBzOi8vY2RuLm5sYXJrLmNvbS95dXF1ZS9fX3B1bWwvMjk4MjIwZDIxNzJkNzYxNDc3YWM5ZjAxMWVjZTA2ZTYuc3ZnIiwiaWQiOiJFUDIyTCIsIm1hcmdpbiI6eyJ0b3AiOnRydWUsImJvdHRvbSI6dHJ1ZX0sImhlaWdodCI6OTg1LCJjYXJkIjoiZGlhZ3JhbSJ9)

# 后台

**流程：**
设备注册（protocol.MessageType_REGISTER_REQUEST）-> 响应返回（新增 timezone 字段）

```protobuf
message RegisterResponse {
  required bool   status    = 1;
  required string time_zone = 2;  // ADD 设备所在时区地区
}
```

测量类型（protocol.MessageType_SCANTYPE_REQUEST）-> 请求参数（新增 utc 字段）

```protobuf
message ScanTypeRequest
{
  required string device_id = 1;
  required string scan_id = 2;
  required uint32 bia_measure = 3;  //体成分测量
  required uint32 eval_measure = 4;  //体态测量
  required string utc = 5;       // ADD 设备测量时所处时区
}
```

_​_

# B 端

## 时区设置入口

- \*\* \*\*B 端账号设置增加（Timezone Settings）<时区设置>选项

  ![image.png](https://cdn.nlark.com/yuque/0/2021/png/21852402/1624848219797-2e6ace88-f997-4440-9c94-a9e237b72591.png#clientId=ub6c643ec-5885-4&from=paste&height=439&id=u0fc48d91&margin=%5Bobject%20Object%5D&name=image.png&originHeight=439&originWidth=547&originalType=binary&ratio=1&size=62273&status=done&style=none&taskId=u0d0c7ffe-b0c9-44aa-8085-74e7d7176fe&width=547)

## 时区设置列表

![image.png](https://cdn.nlark.com/yuque/0/2021/png/21852402/1624848281604-9c74b15b-2cad-4298-86d8-f9fd1470b5b9.png#clientId=ub6c643ec-5885-4&from=paste&height=811&id=u8d5cac23&margin=%5Bobject%20Object%5D&name=image.png&originHeight=811&originWidth=1445&originalType=binary&ratio=1&size=159149&status=done&style=none&taskId=uee4c4efc-69b7-4078-add6-cd7445fd719&width=1445)

- 搜索匹配内容

![image.png](https://cdn.nlark.com/yuque/0/2021/png/21852402/1624848347633-fdb7ed66-44c0-4a1c-b535-7776d65d2c03.png#clientId=ub6c643ec-5885-4&from=paste&height=640&id=uf49eb3c2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=640&originWidth=1144&originalType=binary&ratio=1&size=76624&status=done&style=none&taskId=uca84beba-517c-4817-866c-d4e2de5c9cd&width=1144)

- 搜索无匹配内容

![image.png](https://cdn.nlark.com/yuque/0/2021/png/21852402/1624848369301-20a24e30-cd8a-46f0-89f1-b8a29e12ae53.png#clientId=ub6c643ec-5885-4&from=paste&height=641&id=u18f4419b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=641&originWidth=1141&originalType=binary&ratio=1&size=47679&status=done&style=none&taskId=u70ffaff1-b2ea-4ff1-a589-69300b25bc8&width=1141)

- 设置成功

![image.png](https://cdn.nlark.com/yuque/0/2021/png/21852402/1624848388279-c94c7732-6ea5-436d-82a3-a674c5493c60.png#clientId=ub6c643ec-5885-4&from=paste&height=632&id=ub4c8bcbe&margin=%5Bobject%20Object%5D&name=image.png&originHeight=632&originWidth=1135&originalType=binary&ratio=1&size=104150&status=done&style=none&taskId=u54080bd5-7371-4ed1-883d-bcc117fde78&width=1135)
规则：

| **元素**     | **说明**                                                                                                     |
| ------------ | ------------------------------------------------------------------------------------------------------------ |
| 介绍设置时间 | 请选择您的时区，手动重启设备生效                                                                             |
| 入口         | 账号设置--Timezone Settings<时区设置>                                                                        |
| 列表         | 仅支持单选，滚动加载                                                                                         |
| 搜索         | 搜索框，可输入国家或时区或地区，支持模糊搜索，搜索后列表只保留匹配的内容，若无对应内容，则反馈“无匹配内容”。 |

字符：支持任意字符；
长度：50，超过 50 字符后不可继续输入 |
| 提交 | 提交按钮，选择后提交保存，弹出保存成功提示框，点击 ok 停留在当前页 |

**需要的接口及字段：**

1. 时区数据列表接口

返回字段：Timezone, Country, Major cities，国旗图片名称

2. 搜索接口

入参字段：时区，国家，城市
返回字段：Timezone, Country, Major cities，国旗图片名称

3. 提交接口

入参字段：数据对应 id

## 时区设置语言包

语言包全部按英文的

# 后端

## 新增 timezone 相关接口

```graphql
type Query {
  "查询timezone列表"
  findTimeZoneList(page: Int!, take: Int!, queryParam: String): TimeZoneList
}

type Mutation {
  "更新账号所属设备的TimeZone"
  updateTimeZone(tzId: Int!): GymCommonResult
}

type GymCommonResult {
  code: Int
  message: String
}

type TimeZoneList {
  "状态码"
  code: Int
  "返回消息"
  message: String
  "返回数据"
  data: [TimeZone]
  "分页"
  pagination: Pagination
}

type Pagination {
  "总条数"
  totalItems: Int
  "当前页"
  currentPage: Int
  "当前页内有多少条数据"
  pageSize: Int
  "总页数"
  totalPages: Int
  "开始页"
  startPage: Int
  "结束页"
  endPage: Int
  "开始下标"
  startIndex: Int
  "结束下标"
  endIndex: Int
  "页码列表"
  pages: [Int]
}

type TimeZone {
  "ID"
  tzId: Int
  "time zone"
  timeZone: String
  "国家"
  country: String
  "城市"
  cities: String
  "图标名称 国家名称缩写"
  icon: String
}
```

## 时区设置后需要修改接口：

- B 端测量报告列表的测量时间 `findReportTaskList`
- B 端绑定报告列表的测量时间 `findBindTaskList`
- 纸质报告的测量时间` findScanAdditionalInfo`
- 报告中的与上次对比，按照每份报告的时区时间对比
  - 体成分对比 `bmMassContrastInfo - findBeforeBmBiaScan`
  - 体围对比 `bmGirthContrastInfo - findBeforeBsScan`
  - 体态对比 `bsEvalInfo、bsEvalConclusion - findBeforeBsScan`
  - 报告分数对比 `bodyScore - findBeforeBmBiaScan`
  - 报告身体状态对比 `getBodyStateInfo - findBeforeBmBiaScan`、`findBeforeBsScan`

# 设备端

## 时区设置

- 开机时获取该设备所在的地区，判断是否与设备当前地区一致：

  - 若不一致，则调用 linux 系统命令设置对应地区，使用当地时区，设置完成后，进入开机动画；

  设置时需打开系统夏令时判断，设置地区后，自动根据当地时间变化。（linux 支持）

- 若一致，则直接进入开机动画。
- 异常处理

  - 本次开机不再进行地区设置，设置当前本地时区，直接进入开机动画，进行自检及异常反馈。

  ** 流程**​**：**
  在 videos.vue 中开机动画前进行判断 -> \_checkTimeZone 时区设置- >控制服务设置时区 handleChangeTimeZoneReq 方法在<display.js >

```javascript
created() {
  if（deviceInfo中的timeZone&&isNetConnect && videoNum===6）{
    获取本地设备时间和deviceInfo(timeZone) 进行对比（运维给的一个脚本进行比对和时间设置）
  }
}
```

## 时区上传

- 时区设置仅对设置后进行的测量生效，历史报告不修改时区。

** 流程：**
1.?启动测量 handleScanReq 方法在<display.js > ->controlServer.js(case:12) 接受到信息
-> 根据（timeZone）处理时区（common.js）并更新 measureInfo<vuex> ->
​

```javascript
commit(types.CHANGE_MEATURE_INFO, {
    scanid: scanid,
    utc:  // add  Time zone conversion
})
```

​

       2. ?通知测量类型handleScanTypeReq  方法在<display.js >
                涉及到的页面getReport.vue(130行,95行)，scanResult.vue(175行)

```javascript
// 发送测量类型
handleScanTypeReq(this.deviceInfo.id, this.measureInfo.scanid, this.measureInfo.scanType，this.measureInfo.utc（//add）)
```

     携带 **处理过 **的时区【 deviceInfo（utc）】+ 本地_getTimeZone （address）-> 接受到通知statusServer.js(case:14)（更新measureInfo 及 scanQueue ）<vuex>)

```javascript
// 测量信息
measureInfo: {
    // 扫描id
    scanid: '',
    // 体成分
    mass: false,
    // 体态评估
    shape: false,
    // 体重
    weight: false,
    // 当前测量项
    active: 1, // 1 体成分 2 体态 3 体重
    // 测量类型
    scanType: 0, // 1 体测 2 体态 3 体测+体态
    // 服务器返回的测量时间
    scanTime: '',
    // 加入打印队列时是否自动打印 0 手动 1 自动
    printType: 1,
    // 未测量的项目
    unScanItems: [3, 2],
    // 增加 时区
    utc: '' // add Time zone conversion
},
```

## 时间设置后时间显示

- 待机页的实时时间显示：js 获取最新的本机时间
- 设备端列表中，测量报告的测量时间：原 scanTime 改为 **scanTime + utc**
- 报告排序按测量顺序：printQ (vuex) (288 行)，原 scanTime 排序 显示列表时间为 **scanTime utc **

​

#

​

#

​
